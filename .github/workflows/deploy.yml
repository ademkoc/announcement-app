name: Deploy to Ubuntu Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H your.server.ip >> ~/.ssh/known_hosts

    - name: Deploy via SSH
      run: |
        ssh -i ~/.ssh/id_ed25519 adem@78.178.171.138 << 'EOF'
          cd /home/adem/announcement-app
          git pull origin main
          npm install
          npm run build
          export $(grep -v '^#' .env | xargs)
          cd ./dist
          pm2 start ./src/server.js --name announcement-app --watch --ignore-watch="node_modules"
        EOF